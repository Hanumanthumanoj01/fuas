<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI"
             xmlns:dc="http://www.omg.org/spec/DD/20100524/DC"
             xmlns:di="http://www.omg.org/spec/DD/20100524/DI"
             xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             id="Definitions_1"
             targetNamespace="http://bpmn.io/schema/bpmn"
             exporter="Camunda Modeler"
             exporterVersion="4.6.0">

  <process id="service-request-process" name="External Service Procurement" isExecutable="true" camunda:historyTimeToLive="P180D">

    <startEvent id="StartEvent_1" name="Request Submitted">
      <outgoing>Flow_1</outgoing>
    </startEvent>

    <sequenceFlow id="Flow_1" sourceRef="StartEvent_1" targetRef="Activity_CheckInternal" />

    <serviceTask id="Activity_CheckInternal" name="Check Internal Workforce" camunda:delegateExpression="${checkInternalResourceDelegate}">
      <outgoing>Flow_2</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_2" sourceRef="Activity_CheckInternal" targetRef="Gateway_InternalCheck" />

    <exclusiveGateway id="Gateway_InternalCheck" name="Internal Resource Available?">
      <incoming>Flow_2</incoming>
      <outgoing>Flow_Internal_Success</outgoing>
      <outgoing>Flow_Internal_Fail</outgoing>
    </exclusiveGateway>

    <sequenceFlow id="Flow_Internal_Success" name="Yes" sourceRef="Gateway_InternalCheck" targetRef="EndEvent_InternalFound">
      <conditionExpression xsi:type="tFormalExpression">${internalResourceAvailable == true}</conditionExpression>
    </sequenceFlow>

    <endEvent id="EndEvent_InternalFound" name="Request Cancelled (Internal Found)" />

    <sequenceFlow id="Flow_Internal_Fail" name="No" sourceRef="Gateway_InternalCheck" targetRef="Activity_CheckContract">
      <conditionExpression xsi:type="tFormalExpression">${internalResourceAvailable == false}</conditionExpression>
    </sequenceFlow>

    <serviceTask id="Activity_CheckContract" name="Validate Contract" camunda:delegateExpression="${checkContractDelegate}">
      <outgoing>Flow_3</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_3" sourceRef="Activity_CheckContract" targetRef="Activity_PO_Approval" />

    <userTask id="Activity_PO_Approval" name="${title}" camunda:assignee="po_user">
      <incoming>Flow_3</incoming>
      <incoming>Flow_RejectionFix</incoming>
      <outgoing>Flow_4</outgoing>
    </userTask>

    <sequenceFlow id="Flow_4" sourceRef="Activity_PO_Approval" targetRef="Gateway_Approved" />

    <exclusiveGateway id="Gateway_Approved" name="Approved?">
      <incoming>Flow_4</incoming>
      <outgoing>Flow_Yes_Approved</outgoing>
      <outgoing>Flow_No_Approved</outgoing>
    </exclusiveGateway>

    <sequenceFlow id="Flow_No_Approved" name="No" sourceRef="Gateway_Approved" targetRef="Activity_PM_Fix">
      <conditionExpression xsi:type="tFormalExpression">${approved == false}</conditionExpression>
    </sequenceFlow>

    <userTask id="Activity_PM_Fix" name="${title} (Fix Rejection)" camunda:assignee="pm_user">
      <incoming>Flow_No_Approved</incoming>
      <outgoing>Flow_RejectionFix</outgoing>
    </userTask>

    <sequenceFlow id="Flow_RejectionFix" sourceRef="Activity_PM_Fix" targetRef="Activity_PO_Approval" />

    <sequenceFlow id="Flow_Yes_Approved" name="Yes" sourceRef="Gateway_Approved" targetRef="Activity_Publish">
      <conditionExpression xsi:type="tFormalExpression">${approved == true}</conditionExpression>
    </sequenceFlow>

    <serviceTask id="Activity_Publish" name="Publish to Providers" camunda:delegateExpression="${publishToProvidersDelegate}">
      <outgoing>Flow_5</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_5" sourceRef="Activity_Publish" targetRef="Activity_PM_Evaluate" />

    <userTask id="Activity_PM_Evaluate" name="${title}" camunda:assignee="pm_user">
      <incoming>Flow_5</incoming>
      <incoming>Flow_Contract_Rejected</incoming> <outgoing>Flow_6</outgoing>
    </userTask>

    <sequenceFlow id="Flow_6" sourceRef="Activity_PM_Evaluate" targetRef="Activity_PO_Validate" />

    <userTask id="Activity_PO_Validate" name="${title}" camunda:assignee="po_user">
      <incoming>Flow_6</incoming>
      <outgoing>Flow_7</outgoing>
    </userTask>

    <sequenceFlow id="Flow_7" sourceRef="Activity_PO_Validate" targetRef="Gateway_ContractVerified" />

    <exclusiveGateway id="Gateway_ContractVerified" name="Contract Valid?">
      <incoming>Flow_7</incoming>
      <outgoing>Flow_Contract_OK</outgoing>
      <outgoing>Flow_Contract_Rejected</outgoing>
    </exclusiveGateway>

    <sequenceFlow id="Flow_Contract_Rejected" name="No" sourceRef="Gateway_ContractVerified" targetRef="Activity_PM_Evaluate">
      <conditionExpression xsi:type="tFormalExpression">${verified == false}</conditionExpression>
    </sequenceFlow>

    <sequenceFlow id="Flow_Contract_OK" name="Yes" sourceRef="Gateway_ContractVerified" targetRef="Activity_RP_Coordination">
      <conditionExpression xsi:type="tFormalExpression">${verified == true}</conditionExpression>
    </sequenceFlow>

    <userTask id="Activity_RP_Coordination" name="${title}" camunda:assignee="rp_user">
      <incoming>Flow_Contract_OK</incoming>
      <outgoing>Flow_8</outgoing>
    </userTask>

    <sequenceFlow id="Flow_8" sourceRef="Activity_RP_Coordination" targetRef="Activity_CreateOrder" />

    <serviceTask id="Activity_CreateOrder" name="Create Service Order" camunda:delegateExpression="${createServiceOrderDelegate}">
      <outgoing>Flow_9</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_9" sourceRef="Activity_CreateOrder" targetRef="Activity_Notify" />

    <serviceTask id="Activity_Notify" name="Notify Provider" camunda:delegateExpression="${notifyProviderDelegate}">
      <outgoing>Flow_NotifyWorkforce</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_NotifyWorkforce" sourceRef="Activity_Notify" targetRef="Activity_NotifyWorkforce" />

    <serviceTask id="Activity_NotifyWorkforce" name="Update Workforce System" camunda:delegateExpression="${notifyWorkforceDelegate}">
      <outgoing>Flow_End</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_End" sourceRef="Activity_NotifyWorkforce" targetRef="EndEvent_Success" />

    <endEvent id="EndEvent_Success" name="Service Order Active" />

  </process>
</definitions>