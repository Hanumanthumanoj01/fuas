<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/BPMN/20100524/MODEL"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             xmlns:camunda="http://camunda.org/schema/1.0/bpmn"
             targetNamespace="http://bpmn.io/schema/bpmn">

  <process id="service-request-process"
           name="External Service Procurement V2"
           isExecutable="true"
           camunda:historyTimeToLive="P180D">

    <!-- ================= START ================= -->
    <startEvent id="StartEvent_1" name="Request Received (1B)">
      <outgoing>Flow_1</outgoing>
    </startEvent>

    <sequenceFlow id="Flow_1"
                  sourceRef="StartEvent_1"
                  targetRef="Activity_CheckContract"/>

    <!-- ============ CONTRACT VALIDATION ============ -->
    <serviceTask id="Activity_CheckContract"
                 name="Validate Contract"
                 camunda:delegateExpression="${checkContractDelegate}">
      <outgoing>Flow_2</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_2"
                  sourceRef="Activity_CheckContract"
                  targetRef="Gateway_Contract_Valid"/>

    <exclusiveGateway id="Gateway_Contract_Valid"
                      name="Contract Valid?"/>

    <!-- ❌ Contract Invalid -->
    <sequenceFlow id="Flow_3"
                  sourceRef="Gateway_Contract_Valid"
                  targetRef="Activity_Notify_Contract_Rejection">
      <conditionExpression xsi:type="tFormalExpression">
        ${contractValid == false}
      </conditionExpression>
    </sequenceFlow>

    <serviceTask id="Activity_Notify_Contract_Rejection"
                 name="Notify 1B (Contract Missing)"
                 camunda:delegateExpression="${notifyContractRejectionDelegate}">
      <outgoing>Flow_4</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_4"
                  sourceRef="Activity_Notify_Contract_Rejection"
                  targetRef="End_No_Contract"/>

    <endEvent id="End_No_Contract"
              name="Process Terminated (No Contract)"/>

    <!-- ✅ Contract Valid -->
    <sequenceFlow id="Flow_5"
                  sourceRef="Gateway_Contract_Valid"
                  targetRef="Activity_PO_Approval">
      <conditionExpression xsi:type="tFormalExpression">
        ${contractValid == true}
      </conditionExpression>
    </sequenceFlow>

    <!-- ================= PO APPROVAL ================= -->
    <userTask id="Activity_PO_Approval"
              name="Approve Request (PO)"
              camunda:assignee="po_user">
      <outgoing>Flow_6</outgoing>
    </userTask>

    <sequenceFlow id="Flow_6"
                  sourceRef="Activity_PO_Approval"
                  targetRef="Gateway_Approved"/>

    <exclusiveGateway id="Gateway_Approved"
                      name="Approved?"/>

    <!-- ❌ PO Reject -->
    <sequenceFlow id="Flow_7"
                  sourceRef="Gateway_Approved"
                  targetRef="Activity_PM_Fix">
      <conditionExpression xsi:type="tFormalExpression">
        ${approved == false}
      </conditionExpression>
    </sequenceFlow>

    <userTask id="Activity_PM_Fix"
              name="Fix Request (PM)"
              camunda:assignee="pm_user">
      <outgoing>Flow_5</outgoing>
    </userTask>

    <!-- ✅ PO Approve -->
    <sequenceFlow id="Flow_8"
                  sourceRef="Gateway_Approved"
                  targetRef="Activity_Publish">
      <conditionExpression xsi:type="tFormalExpression">
        ${approved == true}
      </conditionExpression>
    </sequenceFlow>

    <!-- ================= PUBLISH ================= -->
    <serviceTask id="Activity_Publish"
                 name="Publish to Providers"
                 camunda:delegateExpression="${publishToProvidersDelegate}">
      <outgoing>Flow_9</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_9"
                  sourceRef="Activity_Publish"
                  targetRef="Activity_PM_Evaluate"/>

    <userTask id="Activity_PM_Evaluate"
              name="Evaluate Offers (PM)"
              camunda:assignee="pm_user">
      <outgoing>Flow_10</outgoing>
    </userTask>

    <sequenceFlow id="Flow_10"
                  sourceRef="Activity_PM_Evaluate"
                  targetRef="Activity_PO_Validate"/>

    <userTask id="Activity_PO_Validate"
              name="Validate Selection (PO)"
              camunda:assignee="po_user">
      <outgoing>Flow_11</outgoing>
    </userTask>

    <sequenceFlow id="Flow_11"
                  sourceRef="Activity_PO_Validate"
                  targetRef="Gateway_Selection_Approved"/>

    <exclusiveGateway id="Gateway_Selection_Approved"
                      name="Selection Valid?"/>

    <!-- ❌ Selection Reject -->
    <sequenceFlow id="Flow_12"
                  sourceRef="Gateway_Selection_Approved"
                  targetRef="Activity_PM_Evaluate">
      <conditionExpression xsi:type="tFormalExpression">
        ${selectionApproved == false}
      </conditionExpression>
    </sequenceFlow>

    <!-- ✅ Selection Approve -->
    <sequenceFlow id="Flow_13"
                  sourceRef="Gateway_Selection_Approved"
                  targetRef="Activity_Notify_1b">
      <conditionExpression xsi:type="tFormalExpression">
        ${selectionApproved == true}
      </conditionExpression>
    </sequenceFlow>

    <!-- ================= 1B DECISION ================= -->
    <serviceTask id="Activity_Notify_1b"
                 name="Send Recommendation to 1B"
                 camunda:delegateExpression="${notify1bRecommendationDelegate}">
      <outgoing>Flow_14</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_14"
                  sourceRef="Activity_Notify_1b"
                  targetRef="Event_Wait_1b"/>

    <receiveTask id="Event_Wait_1b"
                 name="Wait for 1B Decision"
                 messageRef="Message_1b_Decision"
                 camunda:asyncBefore="true">
      <outgoing>Flow_15</outgoing>
    </receiveTask>

    <sequenceFlow id="Flow_15"
                  sourceRef="Event_Wait_1b"
                  targetRef="Gateway_1b_Decision"/>

    <exclusiveGateway id="Gateway_1b_Decision"
                      name="1B Decision?"/>

    <!-- ❌ 1B Reject -->
    <sequenceFlow id="Flow_16"
                  sourceRef="Gateway_1b_Decision"
                  targetRef="Activity_Notify_Reject">
      <conditionExpression xsi:type="tFormalExpression">
        ${oneBDecision == 'REJECTED'}
      </conditionExpression>
    </sequenceFlow>

    <serviceTask id="Activity_Notify_Reject"
                 name="Notify Provider (Rejected)"
                 camunda:delegateExpression="${notifyProviderRejectDelegate}">
      <outgoing>Flow_17</outgoing>
    </serviceTask>

    <endEvent id="End_Rejected"
              name="Request Rejected by 1B"/>

    <sequenceFlow id="Flow_17"
                  sourceRef="Activity_Notify_Reject"
                  targetRef="End_Rejected"/>

    <!-- ✅ 1B Accept -->
    <sequenceFlow id="Flow_18"
                  sourceRef="Gateway_1b_Decision"
                  targetRef="Activity_RP_Coordination">
      <conditionExpression xsi:type="tFormalExpression">
        ${oneBDecision == 'ACCEPTED'}
      </conditionExpression>
    </sequenceFlow>

    <!-- ================= ORDER CREATION ================= -->
    <userTask id="Activity_RP_Coordination"
              name="Confirm Logistics (RP)"
              camunda:assignee="rp_user">
      <outgoing>Flow_19</outgoing>
    </userTask>

    <sequenceFlow id="Flow_19"
                  sourceRef="Activity_RP_Coordination"
                  targetRef="Activity_CreateOrder"/>

    <serviceTask id="Activity_CreateOrder"
                 name="Create Service Order"
                 camunda:delegateExpression="${createServiceOrderDelegate}">
      <outgoing>Flow_20</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_20"
                  sourceRef="Activity_CreateOrder"
                  targetRef="Activity_Notify_Win"/>

    <serviceTask id="Activity_Notify_Win"
                 name="Notify Provider (Win)"
                 camunda:delegateExpression="${notifyProviderDelegate}">
      <outgoing>Flow_21</outgoing>
    </serviceTask>

    <sequenceFlow id="Flow_21"
                  sourceRef="Activity_Notify_Win"
                  targetRef="Activity_NotifyWorkforce"/>

    <serviceTask id="Activity_NotifyWorkforce"
                 name="Update Workforce System"
                 camunda:delegateExpression="${notifyWorkforceDelegate}">
      <outgoing>Flow_22</outgoing>
    </serviceTask>

    <endEvent id="End_Success"
              name="Service Order Active"/>

    <sequenceFlow id="Flow_22"
                  sourceRef="Activity_NotifyWorkforce"
                  targetRef="End_Success"/>

  </process>

  <message id="Message_1b_Decision"
           name="Message_1b_Decision"/>

</definitions>
